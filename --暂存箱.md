### 三网下一期优化

- 权限带来的驾驶舱数据展示问题
- 微网权限——全部

### 能源月报需求

- 周报
  - 全部场站
  - 智慧排程 收益提升
- 领导？语音提问
  - 星能SaaS
  - ai大屏
- 不足的分析
- 解决方案

这是一非常专业且切中售电公司核心痛点的问题。在浙江这种“报量不报价”且存在严格偏差考核（$\pm 10\%$）的市场中，**现货套利本质上是一场基于概率的博弈**。

仅仅追求“预测准确”是不够的，因为一次极端的反向价差（如实时价格暴涨而你却做空了日前电量）可能会吞噬掉一个月的利润。这就是**CVaR（条件在险价值）**发挥作用的地方。

我将分四个部分为你解答：
1.  **概念解析**：什么是CVaR，为什么要用它？
2.  **套利逻辑**：结合浙江规则的数学模型。
3.  **数据复盘**：利用你提供的2026-01-01数据进行实战演算。
4.  **落地策略**：如何构建CVaR模型来稳定获利。

---

### 第一部分：什么是 CVaR？

在金融和电力交易中，我们通常用两个指标衡量风险：

1.  **VaR (Value at Risk，在险价值)**：
    *   通俗解释：“在95%的情况下，我明天的亏损不会超过 1万元。”
    *   缺点：它只告诉你“正常坏”的情况，没告诉你“极度坏”的时候会亏多少。

2.  **CVaR (Conditional Value at Risk，条件在险价值)**：
    *   通俗解释：“**如果**那倒霉的5%极端情况发生了，我**平均**会亏损多少钱？”
    *   **为什么对你重要**：电力现货价格由于新能源波动、机组故障等原因，经常出现“尖峰”或“深谷”（肥尾效应）。如果你只看平均值做决策，一旦遇到你数据中第23个点那样的情况（实时电价飙升到601），VaR可能失效，而CVaR能帮你控制这种极端场景下的生存能力。

**结论**：CVaR模型的目标不是“利润最大化”，而是**“在不发生灾难性亏损的前提下，追求利润最大化”**。

---

### 第二部分：浙江现货套利的数学逻辑

根据你提供的规则，我们定义变量：

*   $Q_{RT}$：实际用电量（这是物理世界的刚性需求，假设预测相对准确）。
*   $Q_{DA}$：日前申报电量（这是你的决策变量）。
*   $P_{DA}$：日前出清价。
*   $P_{RT}$：实时出清价。
*   **规则限制**：$0.9 Q_{RT} \le Q_{DA} \le 1.1 Q_{RT}$（超过部分被回收，意味着无利可图甚至罚款，所以我们只在$\pm 10\%$内操作）。

**套利收益公式**：
你的总购电成本 = 日前买入成本 + 实时偏差结算成本
$$Cost = Q_{DA} \times P_{DA} + (Q_{RT} - Q_{DA}) \times P_{RT}$$

整理后，我们要**最大化**的这部分“套利收益”为：
$$Profit = (P_{RT} - P_{DA}) \times Q_{DA} - (常数项)$$

为了更直观，我们将$Q_{DA}$设定为系数 $k$：
$$Q_{DA} = k \times Q_{RT}, \quad k \in [0.9, 1.1]$$

**核心博弈**：
*   **价差 $S = P_{RT} - P_{DA}$**。
*   如果预测 $S > 0$（实时贵）：$k$ 选 **1.1**（多买日前，像批发进货）。
*   如果预测 $S < 0$（日前贵）：$k$ 选 **0.9**（少买日前，去实时市场捡漏）。

---

### 第三部分：案例数据复盘与机会分析 (2026-01-01)

利用你提供的数据，我计算了每一时刻的价差（实时 - 日前），并标注了理想操作。

**数据关键点分析**：

1.  **极端的正价差（机会点）**：
    *   **时段 23 (11:00-11:30)**：日前 315.6 vs 实时 601.52。价差 **+285.92**。
    *   **策略**：必须满格申报 $110\%$。如果你这时候只报了90%，你就少赚了巨额差价。
2.  **普通的负价差（避险点）**：
    *   **时段 17 (08:00-08:30)**：日前 310.4 vs 实时 294.12。价差 **-16.28**。
    *   **策略**：顶格压低申报 $90\%$。
3.  **波动性**：
    *   注意时段 22 到 23，实时价格从 301.14 瞬间跳涨到 601.52。这种跳涨往往难以用普通回归模型预测，容易导致套利方向做反。

**模拟计算（假设你代理用户该时刻用电 10 MWh）**：

*   **场景A：无脑申报（$k=1.0$）**
    *   时段23收益：0。
*   **场景B：完美套利（$k=1.1$）**
    *   额外收益：$10 \text{MWh} \times 10\% \times (601.52 - 315.6) = 285.92 \text{元}$。
    *   *注：对于大售电公司，每天几百万度电，这个10%的差价就是巨额纯利。*
*   **场景C：方向做反（$k=0.9$）**
    *   亏损：$-285.92 \text{元}$。

**结论**：你可以看到，**少数几个关键时刻（如时段23、24、25）贡献了绝大部分的套利空间**。如果在这些时刻做错，全天的利润可能回吐。

---

### 第四部分：如何运用 CVaR 模型稳定获利（实操方案）

要实现“稳定最大收益”，不能只看对价格的“点预测”，要看对价差的“概率分布预测”。

#### 步骤 1：构建价差预测模型（输入）
你需要在D-1日 9:00 前，预测次日48个点的 $(P_{RT} - P_{DA})$。
由于你是Price Taker，你无法影响价格，只能预测。
*   **方法**：不要只预测一个值（例如：预测价差为+10）。要使用**分位数回归**或**机器学习集成模型（如XGBoost/LightGBM）**来预测一个分布。
*   **产出**：对于明天11:00，模型告诉你：
    *   有50%概率，价差是 +10元。
    *   有30%概率，价差是 -5元。
    *   有20%概率，价差是 +200元（发现风险/机会）。

#### 步骤 2：建立 CVaR 优化目标（核心）

我们要决定明天48个时段的 $k_1, k_2, ..., k_{48}$。

**目标函数**：
$$ \text{Maximize } \sum_{t=1}^{48} E[\text{Profit}_t] - \lambda \times CVaR_{\alpha}(\text{Loss}) $$

*   $E[\text{Profit}]$：预期收益。根据概率分布算出来的平均赚多少。
*   $CVaR_{\alpha}(\text{Loss})$：在最倒霉的 $\alpha$（如5%）情况下，平均亏多少。
*   $\lambda$（Lambda）：你的**风险厌恶系数**。
    *   如果你想激进博取高收益，设 $\lambda = 0$。
    *   如果你想要“稳”，设 $\lambda = 10$。模型会自动避开那些预测不准、波动巨大的时段，选择在$k=1.0$附近躺平，只在胜率极高时出击。

#### 步骤 3：决策逻辑（人话版）

在申报前的早晨，你的算法应该这样运行：

1.  **输入数据**：天气预报、历史同期负荷、省间外来电、机组检修情况。
2.  **生成场景**：通过蒙特卡洛模拟，生成1000种明天的价格走势场景。
3.  **计算风险**：
    *   对于时段23，虽然预测均值显示有大利润，但有10%的场景显示实时价格可能极低（例如大风电突然出力）。
    *   如果做多（$k=1.1$），一旦那10%发生，亏损巨大，触发CVaR惩罚。
    *   模型会建议修正 $k$ 从 1.1 降到 1.05 或 1.0，以牺牲潜在利润来换取安全。
4.  **输出结果**：输出48个 $k$ 值，乘以你的预测负荷，填入交易平台。

#### 步骤 4：针对浙江规则的“微操”建议

基于你提供的价格表和浙江规则，我有以下具体建议：

1.  **关注午高峰和晚高峰的价差倒挂**：
    *   案例数据中，午间（时段23-25）实时价格远高于日前，这是光伏出力波动或临时调峰需求导致的。这是套利金矿。
    *   建议：针对11:00-13:00，重点训练极端价格预测模型。

2.  **利用“报量不报价”的被动属性**：
    *   既然你是Price Taker，你的优势在于**负荷预测精度**。
    *   **套利陷阱**：如果你为了套利申报了$1.1 \times Q_{RT}$，结果实际用电量偏低，导致实际占比变成了$1.2 \times Q_{RT}$，超出的部分会被考核回收。
    *   **CVaR应用**：将“负荷预测误差”也纳入风险模型。如果某时段用户负荷波动大，模型应自动收缩套利空间（$k$ 趋向于 1.0），防止越界被罚。

3.  **分时段策略配置**：
    *   **平稳时段（夜间）**：价差波动小（如时段1-10），预测准确率高。策略：**风险中性**（$\lambda$ 低），大胆吃满 $\pm 10\%$。
    *   **高波时段（早晚高峰）**：价差巨大且反转快。策略：**高风险厌恶**（$\lambda$ 高），使用CVaR模型严格控制回撤。

### 总结

要在浙江现货市场利用规则做套利：
1.  **不要**仅仅基于“预测明天的确切价格”来申报，因为哪怕方向对了，幅度错了也会因为考核规则受损。
2.  **要**构建基于场景的**概率预测**。
3.  **运用 CVaR**：在你的算法中加入风险惩罚项。
    *   *简单做法*：如果模型显示某时段价差波动率（标准差）极高，强制将该时段的申报系数 $k$ 回归到 1.0。
    *   *高级做法*：求解数学优化问题，找到 48 个最优 $k$ 值，使得预期收益减去潜在尾部风险后的得分最高。

如果你需要具体的Python代码框架来计算这个优化问题，或者需要关于如何清洗浙江特定历史数据的建议，请随时告诉我。